<!--  -->
<template>
    <div class="SkuTable left">
    <h1 class="mb-10">商品规格</h1>
    <SkuSelect
      ref="SkuSelect"
      :specifications="spec_list"
      @change="onSkuSelectChange"/>
    <h1 class="mb-10" style="margin-top:20px">批量设置</h1>
    <el-form class="mb-10 flex wrap" style="padding-left:15px" size="small" :model="batchEditForm">
      <el-form-item>
        <el-select
          v-model="batchEditForm[spec.spec_id]"
          placeholder="请选择"
          v-for="(spec, index) in  spec_list"
          :key="index"
          style="width:130px"
          class="mr-5">
          <el-option
            :label="`全部${spec.name}`"
            :value="-1">
          </el-option>
          <el-option
            v-for="item in spec.value_list"
            :key="item.spec_detail_id"
            :label="item.name"
            :value="item.spec_detail_id">
          </el-option>
        </el-select>
      </el-form-item>
      <el-form-item>
        <el-input  class="mr-5" style="width:130px" v-model="batchEditForm.price" placeholder="价格"></el-input>
      </el-form-item>
      <el-form-item>
        <el-input  class="mr-5" style="width:130px" v-model="batchEditForm.quantity" placeholder="库存"></el-input>
      </el-form-item>
      <el-form-item>
        <el-input  class="mr-5" style="width:130px" v-model="batchEditForm.code" placeholder="编码"></el-input>
      </el-form-item>
      <el-form-item>
        <el-button size="medeium" type="primary" plain style="width:80px;height:32px;padding:0" @click="handleBatchEdit">设置</el-button>
      </el-form-item>

    </el-form>
    <h1 class="mb-10" style="margin-top:20px">价格与库存</h1>
        <el-form :rules="rules" ref="form" :model="tableData" size="small" style="padding-left:15px">
            <el-table
            :data="tableData"
            :span-method="spanMethod"
            cell-class-name="cell-class-name"
            style="width: 100%">
            <el-table-empty slot="empty"/>
            <el-table-column
                v-for="(spec, index) in  spec_list"
                fixed
                :key="index"
                :label="spec.name"
                width="150">
                <template slot-scope="scope">
                    <span >{{getRowData(scope.row,index)}}</span>
                </template>
            </el-table-column>
            <el-table-column
                prop="quantity"
                label="总库存"
                width="130">
                <template slot-scope="scope">
                    <el-form-item  :prop="`[${scope.row.index}].quantity`">
                        <el-input v-model="scope.row.quantity" placeholder="请输入"></el-input>
                    </el-form-item>
                </template>
            </el-table-column>
            <el-table-column
                prop="address"
                label="价格"
                width="130">
                <template slot-scope="scope">
                    <el-form-item  class="relative" :prop="`[${scope.row.index}].price`">
                        <span class="unit">¥</span>
                        <el-input class="price" v-model="scope.row.price" placeholder="请输入"></el-input>
                    </el-form-item>
                </template>
            </el-table-column>
            <el-table-column
                prop="address"
                label="商品编码"
                >
                <template slot-scope="scope">
                    <el-form-item  :prop="`[${scope.row.index}].code`">
                        <el-input v-model="scope.row.code" placeholder="请输入"></el-input>
                    </el-form-item>
                </template>
            </el-table-column>
            <el-table-column
                prop="address"
                label="预览图"
                width="90"
                align="center" >
                <template slot-scope="scope">
                    <div class="preview imgWrapper" style="padding:4px" v-if="scope.row.img">
                      <el-popover
                        placement="left"
                        width="270"
                        trigger="hover">
                        <img :src="scope.row.img" style="width: 250px;"/>
                        <div
                          slot="reference">
                          <el-image
                            slot="reference"
                            style="width: 40px; height: 40px"
                            class="pointer"
                            :src="scope.row.img">
                          </el-image>
                        </div>
                        </el-popover>
                    </div>
                </template>
            </el-table-column>
            </el-table>
        </el-form>
    </div>
</template>

<script>
import utils from '@/common/utils'
import SkuSelect from './SkuSelect'
export default {
  name: 'component_name',
  props: {
    sku_json: Object
  },
  components: {
    SkuSelect
  },
  data () {
    return {
      specifications: [],
      spec_list: [],
      spec_price_list: [],
      tableData: [],
      batchEditForm: {

      }
    }
  },
  computed: {
    rules () {
      const priceRules = {}

      this.tableData.forEach((item, index) => {
        const key = `[${index}].price`
        priceRules[key] = [
          { required: true, message: '请输入价格', trigger: ['blur', 'change'] }
          // { required: true, message: '请输入0.01到9999999.99的数字，最多保留2位小数', trigger: ['blur', 'change'] }
        ]
      })
      return {
        ...priceRules
      }
    }
  },
  methods: {
    init (skuJson) {
      this.spec_list = skuJson.spec_list
      this.spec_price_list = skuJson.spec_price_list
      const tableData = []
      const specData = this.initTableData(this.spec_list)
      console.log(specData)
      console.log(skuJson.spec_list)
      let recordFirstPrice = false
      specData.forEach((spec, index) => {
        let matchSpecData = {}
        this.spec_price_list.forEach((data, index) => {
          const dataSet = new Set(data.spec_detail_id_list)
          const specSet = new Set(spec)
          const isEqual = [...dataSet].every(x => specSet.has(x))
          if (isEqual) {
            matchSpecData = data
            matchSpecData.price = utils.fenToYuan(matchSpecData.price)
            if (!recordFirstPrice) {
              recordFirstPrice = matchSpecData.price
            }
          } else {
            // 当用户抓取的商品缺少sku时，库存=0，价格取第一个sku价格（库存既然是0了所以价格是多少不重要，只要不是0就行）。从而解决价格=0的问题
            matchSpecData.price = recordFirstPrice
            matchSpecData.quantity = 0
          }
        })

        matchSpecData.index = index
        tableData.push(matchSpecData)
      })
      this.tableData = tableData
      this.originTableData = tableData
      console.log(tableData, 'tableData')
      this.$nextTick(() => {
        this.$refs.SkuSelect && this.$refs.SkuSelect.init(skuJson.spec_list)
      })
    },
    initTableData (list) {
      // 获取阶乘后拼接完整的规格列表
      let specList = [...list]
      let result = [[]]
      while (specList.length) {
        const currentData = specList.shift()
        let originResult = []
        result.forEach((r = []) => {
          currentData.value_list.forEach(spec => {
            const nextSpecs = [...r]
            nextSpecs.push(spec.spec_detail_id)
            originResult.push(nextSpecs)
          })
        })
        result = originResult
      }
      return result
    },
    getForm () {
      this.$refs.form.validate((valid, object) => {
        console.log(valid, object)
      })
    },
    getRowData (row, index) {
      const specList = this.spec_list
      let text = ''
      specList.forEach(spec => {
        (spec.value_list || []).forEach(value => {
          if (row.spec_detail_id_list && row.spec_detail_id_list[index] && value.spec_detail_id === row.spec_detail_id_list[index]) {
            text = value.name
          }
        })
      })
      return text
    },
    // 格式化数据
    onSkuSelectChange (specifications, type) {
      // 当用户删除sku时，剩下的sku原本是多少价格、库存就展示多少价格、库存；
      // 当用户修改sku名称时，价格不变；
      // 当用户新增sku时，价格、库存为空，用户点击【保存编辑】需toast提示用户填写价格、库存，若不填写则无法保存
      const specData = this.initTableData(specifications)
      const tableData = []
      specData.forEach((spec, index) => {
        let matchSpecData = {}
        this.tableData.forEach((data) => {
          const dataSet = new Set(data.spec_detail_id_list)
          const specSet = new Set(spec)
          // 元数据内规格包含 新的规格 获取原始数据
          const minus = [...dataSet].filter(x => !specSet.has(x))
          if (!minus.length) {
            matchSpecData = data
          }
        })
        // 将元数据规格更新为新的规格
        matchSpecData.spec_detail_id_list = spec
        matchSpecData.price = typeof matchSpecData.price !== 'undefined' ? matchSpecData.price : ''
        matchSpecData.quantity = typeof matchSpecData.quantity !== 'undefined' ? matchSpecData.quantity : ''
        matchSpecData.index = index
        tableData.push(matchSpecData)
      })
      this.$nextTick(() => {
        this.tableData = tableData
        this.spec_list = specifications
      })
    },
    // 批量设置
    handleBatchEdit () {
      console.log(this.batchEditForm, '批量设置')
    },
    spanMethod ({ row, column, rowIndex, columnIndex }) {
      const end = this.spec_list.length + 3
      const arr = []
      this.spec_list.map(item => {
        arr.push(item.value_list.length)
      })

      if (arr.length === 3) {
        const columnIndex0 = arr[1] * arr[2]
        const columnIndex1 = arr[2]
        if (columnIndex === 0) {
          if (rowIndex % columnIndex0 === 0) {
            return {
              rowspan: columnIndex0,
              colspan: 1
            }
          } else {
            return {
              rowspan: 0,
              colspan: 0
            }
          }
        } else if (columnIndex === 1) {
          if (rowIndex % columnIndex1 === 0) {
            return {
              rowspan: columnIndex1,
              colspan: 1
            }
          } else {
            return {
              rowspan: 0,
              colspan: 0
            }
          }
        } else if (columnIndex === end) {
          if (rowIndex % columnIndex0 === 0) {
            return {
              rowspan: columnIndex0,
              colspan: 1
            }
          } else {
            return {
              rowspan: 0,
              colspan: 0
            }
          }
        }
      }
      if (arr.length === 2) {
        const columnIndex0 = arr[1]
        if (columnIndex === 0) {
          if (rowIndex % columnIndex0 === 0) {
            return {
              rowspan: columnIndex0,
              colspan: 1
            }
          } else {
            return {
              rowspan: 0,
              colspan: 0
            }
          }
        } else if (columnIndex === end) {
          if (rowIndex % columnIndex0 === 0) {
            return {
              rowspan: columnIndex0,
              colspan: 1
            }
          } else {
            return {
              rowspan: 0,
              colspan: 0
            }
          }
        }
      }

      return {
        rowspan: 1,
        colspan: 1
      }
    }
  }
}
</script>
<style lang="less" scoped>
.SkuTable {
    /deep/ .cell-class-name {
        border-left: 1px solid #F2F2F2;
        padding:0;
        overflow: inherit;
        .cell {
            padding-top: 18px;
        }
    }
    .unit {
        position: absolute;
        left: 8px;
        top: 1px;
        z-index: 1;
        bottom: 0;
        margin: auto;
        line-height: 32px;
        font-size: 14px;
    }
    .price {
        /deep/ .el-input__inner{
            padding-left: 20px;
        }
    }

    /deep/ .el-input__inner {
        &:hover,&:focus {
            border: 1px solid @color-primary;
        }
    }
}

</style>
