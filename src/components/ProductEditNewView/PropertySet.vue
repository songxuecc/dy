<!-- PropertySet 商品属性设置 -->
<template>
    <el-form :model="model" ref="propertySet" v-if="productModel && productModel.length" :rules="rules" size="small" class="mt-10">
        <el-form-item
            v-for="(item,index) in productModel"
            :key="index"
            :prop="item.name"
            :error="item.required && item.value === ''"
            :show-message="item.name !== '品牌'"
            :inline-message="true"
            :class="[!['text','select'].includes(item.type)?'checkbox-form-item':'']"
            label-style="font-size:12px">
            <div style="diplay:flex">
             <span slot="label" style="width:120px;display:inline-block;text-align:right;padding-right:4px">
               <i v-if="item.required && item.name === '品牌'"  style="color:#E02020">*</i>
               <i v-if="item.required && item.name !== '品牌'"  style="color:#E02020">*</i>
               {{item.name}}
              </span>
            <!-- 选择框为品牌 -->
            <span
              class="relative"
              v-if="item.name === '品牌' && item.type === 'select'"
            >
              <el-select
                v-model="model[item.name]"
                :style="{width:  '220px'}"
                filterable
                remote
                reserve-keyword
                placeholder="请输入需要关联的品牌"
                :remote-method="(query) => remoteMethod(query,item,index)"
                @change="handleChange($event,item.name)"
                :loading="loading">
                <el-option
                  v-for="option in item.options"
                  :key="option.name"
                  :label="option.name"
                  :value="option.value">
                </el-option>
                <div class="info ml-20">请输入关键词检索品牌</div>
              </el-select>
              <hh-icon type="iconsousuo1" class=" search info"></hh-icon>
            </span>

            <!-- 选择框为非品牌 -->
            <el-select
                clearable
                filterable
                @clear="handleClear(item.name)"
                @change="handleChange($event,item.name)"
                :style="{width: '400px'}"
                :placeholder="`请选择${item.name}`"
                v-model="model[item.name]"
                v-if="(item.options.length && item.name !== '品牌') && item.type === 'select' "
                :default-first-option="true">
                <el-option
                    v-for="(option,index) in item.options"
                    :key="index"
                    :label="option.name"
                    :value="option.value">
                </el-option>
            </el-select>
            <el-checkbox-group
                @change="handleCheckboxChange($event,item.name)"
                :style="{width: item.name !== '品牌' ? '400px' : '190px',display:'inline-block'}"
                :placeholder="`请选择${item.name}`"
                v-model="model[item.name]"
                v-else-if="item.type === 'multi_select'">
                  <el-checkbox
                      class="checkbox"
                      v-for="(option,index) in item.options"
                      :key="index"
                      :label="option.value"
                      :value="option.value">
                      <el-tooltip :content="option.name" class="item" effect="dark" placement="top-start" v-if="option.name.length > 6">
                            <span>{{option.name}}</span>
                      </el-tooltip>
                      <span v-else>{{option.name}}</span>
                  </el-checkbox>
            </el-checkbox-group>
            <el-input
                clearable
                @clear="handleClear(item.name)"
                @change="handleChange($event,item.name)"
                style="width:400px;"
                :placeholder="`请输入${item.name}`"
                v-model="model[item.name]"
                v-else-if="item.type === 'text'"
              />
            <span>

            <span v-if="item.name === '品牌'" class="ml-10 ">
                <el-tooltip content="未搜到需要的品牌？点击申请" placement="top" >
                  <el-button type="text" @click="open(catId)" class="mr-10"> 添加品牌 </el-button>
                </el-tooltip>
                <el-checkbox
                  border
                  :value="!!selected[item.name]"
                  @change="applyPropertiesToSelection($event,item.name)"
                  class="batch" >
                  批量修改同分类商品
                </el-checkbox>
            </span>

              <el-checkbox
                v-if="item.name !== '品牌'"
                border
                @change="applyPropertiesToSelection($event,item.name)"
                :value="!!selected[item.name]"
                class="batch">
                批量修改同分类商品
              </el-checkbox>
              <NewComer type="批量修改同分类商品" ref="newComer" v-if="index === 0"
              :style="{top:'-14px',left:'48%'}">
                <div style="line-height:16px">
                  <div style="width:172px" class="color-666 font-12 left">
                    勾选此处可以批量修改同分类商品的属性哦 ～
                  </div>
                  <div @click="closeNewComer" class="right pointer underline primary">好的</div>
                </div>
              </NewComer>
            </span>
            <slot name="error" v-if="item.name == '品牌' && validation['品牌']">
                <div >
                    <p style="color:red;font-size:12px">当前商品所选类目根据官方要求必须填写品牌。</p>
                    <p style="color:red;font-size:12px">查询哪些类目需要填写品牌 <a href="https://school.jinritemai.com/doudian/web/article/101810" style="color:red;font-size:12px;cursor: pointer">请点击我</a> </p>
                </div>
            </slot>
            </div>

        </el-form-item>
        <div class="tip">
          <p >带<span style="color:#f56c6c">红色 &nbsp;*&nbsp;符号</span> 为必填属性，不填写会导致<span style="color:#f56c6c">商品上传失败</span>。所有属性都不可以输入{{'I,^,&,@'}}字符。</p>
            <!-- 二期会实现本功能 -->
            <!-- <span v-if="catId!==0">，勾选应用到本页相同分类商品，蓝色高亮</span> -->
        </div>
    </el-form >
    <div v-else style="color:#e6a23c">请选择商品分类 填写抖音属性</div>
</template>

<script>
import servises from '@servises'

export default {
  name: 'property-set',
  components: {
  },
  props: {
    catId: {
      type: Number | String,
      default: -1
    },
    ref: {
      type: String
    },
    productModel: {
      type: Object
    },
    propertyBatchMapSelect: {
      type: Object
    },
    forceUpdateKey: {
      type: Number
    }
  },
  data () {
    return {
      model: {},
      validation: {},
      selected: {},
      checkList: [],
      loading: false
    }
  },
  computed: {
    rules () {
      const validatePass = name => (rule, value, callback) => {
        const patrn = /&|@|\^|\|/
        if (patrn.test(value)) {
          callback(new Error(`${name}: 不可以输入特殊字符`))
        } else {
          callback()
        }
      }

      return (this.productModel || []).reduce((target, item) => {
        let message = item.options.length ? `请选择${item.name}` : `请输入${item.name}`
        if (item.name === '品牌') message = ''
        const current = {[item.name]: [
          {required: !!item.required, message, trigger: 'change'},
          { validator: validatePass(item.name), trigger: 'blur' }
        ]}
        return {...target, ...current}
      }, {})
    },
    listenChange () {
      const {productModel, propertyBatchMapSelect, catId, forceUpdateKey} = this
      return {productModel, propertyBatchMapSelect, catId, forceUpdateKey}
    }
  },
  watch: {
    listenChange: {
      handler (newVal, o) {
        const {productModel, propertyBatchMapSelect, catId} = newVal
        const model = (productModel || []).reduce((target, current) => {
          const key = current.name
          let value = current.tp_value
          if (current.type === 'multi_select') {
            if (!Array.isArray(value)) {
              value = []
            }
          }

          // 如果有全选到应用
          if (propertyBatchMapSelect && propertyBatchMapSelect[key] && propertyBatchMapSelect[key].checked) {
            const checkCatId = propertyBatchMapSelect[key].catId
            if (checkCatId === catId) {
              value = propertyBatchMapSelect[key].propertyValue
            }
          }
          return {...target, [key]: value}
        }, {})
        this.model = model
        if (propertyBatchMapSelect && Object.keys(propertyBatchMapSelect).length) {
          const selected = Object.keys(propertyBatchMapSelect).reduce((target, key) => {
            if (!propertyBatchMapSelect[key]) return target
            const checked = propertyBatchMapSelect[key].checked
            const checkCatId = propertyBatchMapSelect[key].catId
            if (checkCatId === catId) {
              return {...target, [key]: checked}
            } else {
              return target
            }
          }, {})
          this.selected = {...selected}
        } else {
          this.selected = {}
        }
      },
      deep: true
    }
  },
  methods: {
    // 验证
    validate () {
      return new Promise((resolve, reject) => {
        if (!this.$refs.propertySet) {
          const msg = '请选择商品属性-修改分类'
          return reject(msg)
        } else {
          this.$refs.propertySet.validate((valid, object) => {
            if (valid) {
              resolve(true)
            } else {
              const error = `${Object.keys(object).join('、')} 输入错误`
              this.validation = object
              reject(error)
            }
          })
        }
      })
    },
    // 清除数据
    clearData () {
      this.data = {}
    },
    // 重置
    resetForm () {
      if (this.$refs && this.$refs.propertySet) {
        this.$refs.propertySet.resetFields()
        this.$refs.propertySet.clearValidate()
      }
      this.validation = {}
    },
    // 清空
    handleClear (name) {
      this.model[name] = ''
    },
    handleChange (value, name) {
      const newModal = Object.assign(this.model, {[name]: value})
      const newAttributeJson = (this.productModel || [])
        .map(item => {
          const tpValue = newModal[item.name] || ''
          return {...item, tp_value: tpValue}
        })
      this.$emit('change', newAttributeJson)
      this.$emit('applyPropertiesToSelection', false, name, '')
    },
    handleCheckboxChange (value, name) {
      console.log(value, 'value')
      const newModal = Object.assign(this.model, {[name]: value})
      const newAttributeJson = (this.productModel || [])
        .map(item => {
          const tpValue = newModal[item.name] || ''
          return {...item, tp_value: tpValue}
        })
      console.log(newAttributeJson, 'newAttributeJson')
      this.$emit('change', newAttributeJson)
      this.$emit('applyPropertiesToSelection', false, name, '')
    },
    applyPropertiesToSelection (value, name) {
      this.closeNewComer()
      const propertyValue = this.model[name]
      this.$emit('applyPropertiesToSelection', value, name, propertyValue)
    },
    open (catId) {
      window.open(`https://fxg.jinritemai.com/index.html#/ffa/goods/qualification/edit?type=2&cid=${catId}`)
    },
    closeNewComer () {
      const ref = this.$refs.newComer
      ref[0] && ref[0].close && ref[0].close()
    },
    remoteMethod (query, item, index) {
      if (query) {
        this.loading = true
        servises.productCategoryBrandList({
          category_id: this.catId,
          keyword: query
        }).then(data => {
          this.$set(item, 'options', data)
          this.loading = false
        })
      } else {
        this.options = []
      }
    }
  }
}
</script>
<style lang="less" scoped>
.tip{
  color: rgb(153, 153, 153);
  margin-top: 10px;
}
/deep/ .el-input__inner{
  text-align: left !important;
  padding-left: 10px !important;
}
/deep/ .el-button+.el-button {
  margin-left: 0px !important;
}
/deep/ .el-form-item__content{
  display:flex;
  align-items:center;
  margin-bottom: 10px;
}
/deep/ .el-form-item__error--inline {

    position: absolute;
    left: 130px;
    bottom: -10px;

}
.batch {
  margin-left: 4px;
}
/deep/ .checkbox {
  width: 115px;
  margin-right: 10px;
  display: inline-flex;
  align-items: center;
  // overflow: hidden;
  // white-space: nowrap;
  // text-overflow: ellipsis;

  .el-checkbox__label {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    width: 95px;
  }
}

.checkbox-form-item {
  /deep/ .el-form-item__content{

    line-height: 20px;
  }
}

.search {
  position: absolute;
  right:10px;
  top:2px;
}
</style>
