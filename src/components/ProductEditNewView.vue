<template lang="html">
  <div style="height: 100%">
    <el-row :gutter="20" style="height: 100%">
      <el-col :span="8" style="height: 100%; padding-right: 0px; padding-bottom: 80px;">
        <el-table ref="productList" :data="productList" row-key="tp_product_id" border :show-header="false" :cell-style="productListCellStyle"
                  :row-style="{height:'68px'}"
                  @current-change="handleProductSelect"
                  style="height: 100%; overflow-y: scroll;"
                  @cell-mouse-enter="handleMouseEnter" @cell-mouse-leave="handleMouseOut" @selection-change="handleSelectionChange"
        >
            <el-table-column width="1">
              <template slot-scope="scope">
                <el-tooltip manual :value="scope.row.index === mouseOverIndex"  v-if="scope.row.status === 5 || scope.row.status === 6 || scope.row.status === 8" :disabled="scope.row.status !== 5 && scope.row.status !== 6 && scope.row.status !== 8" class="item" effect="dark" placement="left">
                    <div slot="content" style="max-width: 180px;" >
                      <ul style="padding: 0; margin: 0; margin-top: 6px;" v-for="(v,i) in scope.row.migration_msg" :key="i">{{v}}</ul>
                    </div>
                    <i></i>
                </el-tooltip>
                <el-tooltip style="max-width: 50px;" manual :value="scope.row.index === mouseOverIndex" v-if="scope.row.status === 7" :disabled="scope.row.status !== 7" class="item" effect="dark" placement="left">
                    <div slot="content" style="max-width: 180px;">
                      <ul v-if="scope.row.migration_msg.length!=0" style="padding: 0; margin: 0;" v-for="(v,i) in scope.row.migration_msg" :key="i">{{v}}</ul>
                      <ul v-if="scope.row.migration_msg.length===1 && scope.row.migration_msg[0].length===0" style="padding: 0; margin: 0;">如需帮助请 <a href="/service" style="color: white;">联系客服</a>。</ul>
                    </div>
                    <i></i>
                </el-tooltip>
              </template>
            </el-table-column>
            <el-table-column type="selection">
            </el-table-column>
            <el-table-column label="图片" width="100" align="center">
                <template slot-scope="scope">
                  <el-badge class="item" :value="Object.values(scope.row.check_error_msg_static).map(item => item.num).reduce((total, num) => total + num)"
                            v-if="scope.row.check_error_msg_static && Object.keys(scope.row.check_error_msg_static).length > 0">
                    <img style="height:60px; max-width: 60px;" :src="scope.row.thumbnail">
                  </el-badge>
                  <img v-else style="height:60px" :src="scope.row.thumbnail">
                  <div v-if="scope.row.isEdit" style="height: 20px; width: 100%; background-color: #fecf23; bottom: 0; left: 0; position: absolute;" >已编辑</div>
                </template>
            </el-table-column>
            <el-table-column label="标题">
                <template slot-scope="scope">
                    <el-link type="primary" target="_blank" :underline="false">
                        {{ productTitleDic[scope.row.tp_product_id] }}
                    </el-link>
                </template>
            </el-table-column>
        </el-table>
      </el-col>
      <el-col :span="16" style="height: 100%; padding-bottom: 100px;">
          <el-tabs v-loading="loadingCnt" v-model="activityTab" type="card" style="height: 100%;" @tab-click="handleTabClick">
              <el-tab-pane label="商品属性" name="info">
                  <span slot="label" v-if=" product.model.check_error_msg_static  && '0' in product.model.check_error_msg_static">商品属性
                    <el-tooltip effect="dark"  placement="top-start">
                      <div slot="content">
                           <ul style="padding: 0; margin: 0;" v-for="(v,i) in product.model.check_error_msg_static['0']['info']" :key="i">{{v}}</ul>
                      </div>
                      <el-badge :value="product.model.check_error_msg_static['0'].num" ></el-badge>
                  </el-tooltip>
                  </span>
                  <el-form class="setting-content" ref="form" :model="product.model" label-width="90px">
                      <el-form-item label="商品分类:">
                          <span>{{ product.model.category_show }}</span>
                          <el-button size="mini" @click="showSelectCateView">修改分类</el-button>
                          <el-button size="mini" type="primary" @click="onApplySelectCateToSelection()" :disabled="product.model.cat_id === 0">应用到选中的商品</el-button>
                      </el-form-item>
                      <el-form-item label="商品标题:" style="margin-right: 20px;">
                          <el-input v-model="product.model.title" size="mini"
                                    :class="['input-text-left', {'warn': (isTitleWarn || isTitleInfoWarn())}]" @input="onProductTitleChange"
                          >
                              <span slot="append" class="hint">{{ parseInt((getStrRealLength(product.model.title)+1)/2) }} / 30</span>
                          </el-input>
                          <el-button size="mini" type="primary" @click="onApplyTitleEditToSelection()">批量编辑选中商品标题</el-button>
                          <!-- <span style="font-size: 10px;">（已自动删除平台违禁词）</span> -->

                      </el-form-item>
                      <el-form-item label="市场价:">
                        <span>{{product.model.price}} 元
                          <el-tooltip manua="true" class="item" effect="dark" placement="top" style="vertical-align: middle">
                              <div slot="content">
                                <ul style="padding: 0; margin: 0;">其他平台市场价，请在上传抖音时设置价格</ul>
                              </div>
                              <i class="el-icon-question"></i>
                          </el-tooltip>
                        </span>
                      </el-form-item>
                      <el-form-item label="商品描述:" style="margin-right: 20px;">
                          <el-input type="textarea" v-model="product.model.description" size="mini"
                                    :autosize="{ minRows: 1, maxRows: 10}" maxlength="500" show-word-limit>
                          </el-input>
                      </el-form-item>
                    <el-form-item label="品牌:">
                      <el-select v-model="product.model.brand_id" placeholder="请选择" size="small" @change="changeBrand" clearable>
                        <el-option v-for="item in shopBrandList" :key="item.id" :value="item.id"
                                   :label="item.brand_chinese_name || item.brand_english_name"
                        ></el-option>
                      </el-select>
                      <el-button type="text" @click="reloadBrandList">
                          <i class="el-icon-refresh"></i>
                      </el-button>
                      <el-link v-if="product.model.cat_id !== 0" type="primary" target="_blank" :underline="false" style="margin-left: 10px;"
                               :href="'https://fxg.jinritemai.com/index.html#/ffa/goods/qualification/edit?type=2&cid=' + product.model.cat_id"
                      >添加品牌</el-link>
                      <el-button size="mini" type="primary" @click="applySelectBrandToSelection()">应用到选中的商品</el-button>
                    </el-form-item>
                    <el-form-item label="商品编码:" style="width:300px" v-if="product.model.outer_id">
                        <el-input v-model="product.model.outer_id" size="mini" class="input-text-left"></el-input>
                    </el-form-item>
                    <el-form-item v-show="haveAttr" label="抖音属性:">
                        <attribute-view ref="attributeView" @selectFilter="selectFilter" @onAttrChanged="onAttrChanged" @updateAttrApplyCat="updateAttrApplyCat"
                        ></attribute-view>
                    </el-form-item>
                  </el-form>
                  <div class="common-bottom">
                  </div>
              </el-tab-pane>

              <el-tab-pane label="SKU信息" name="sku">
                 <span slot="label" v-if=" product.model.check_error_msg_static  && '1' in product.model.check_error_msg_static">SKU信息

                    <el-tooltip effect="dark" placement="top-start">
                      <div slot="content">
                           <ul style="padding: 0; margin: 0;" v-for="(v,i) in product.model.check_error_msg_static['1']['info']" :key="i">{{v}}</ul>
                      </div>
                      <el-badge :value="product.model.check_error_msg_static['1'].num"></el-badge>
                  </el-tooltip>
                  </span>

                  <el-table :data="skuRealShowList" border style="width: 100%" :header-cell-style="cellStyle" class="setting-content"
                            :cell-class-name="cellClassName"
                  >
                      <el-table-column v-for="(item, index) in skuPropertyList" :key="index+':'+item.id">
                          <template slot="header" slot-scope="scope">
                              <span :style="{color: (item.filter ? '#409EFF' : '#909399')}">{{ item.name }}</span>
                              <el-dropdown v-if="skuPropertyValueMap[item.id] && skuPropertyList.length > 1"
                                           style="line-height:0px; padding-left: 0px; cursor:pointer; vertical-align: middle;"
                                           trigger="click" :hide-on-click="false"  placement="bottom" :ref="'sku-property-'+item.id"
                              >
                                  <span class="el-dropdown-link" style="color:#909399">
                                    ({{Object.keys(skuPropertyValueMap[item.id]).length}})<i class="el-icon-edit" style="color: #409EFF"></i>
                                  </span>
                                  <el-dropdown-menu slot="dropdown" style="max-height: 250px; overflow: auto; overflow-x:hidden;">
                                      <el-dropdown-item v-for="(ele, vid) in skuPropertyValueMap[item.id]" :key="vid">
                                          <div style="display:flex">
                                              <el-checkbox v-model="ele.checked" @change="onSkuFilter" style="margin-right: 0">
                                                <span v-if="skuPropertyList.length === 1">{{ele.value}}</span>
                                                <el-input style="width:340px" v-else v-model="ele.value" size="mini" @input="handlePropertyNameChange(item.id, vid, ele)"
                                                          :class="['input-text-left']">
                                                  <span slot="append" class="hint">{{ ele.value.length }} / 18</span>
                                                </el-input>
                                              </el-checkbox>
                                              <el-button v-if="Object.keys(skuPropertyValueMap[item.id]).length > 1" size="mini" type="text" style="color:#F56C6C;margin-left:auto;padding-left: 10px"
                                                         @click="onDeleteSku(item.id,vid)"
                                              > 删除 </el-button>
                                          </div>
                                      </el-dropdown-item>
                                  </el-dropdown-menu>
                              </el-dropdown>
                              <el-button v-if="item.filter" size="small" type="text" class="table-header-btn" @click="cancelSkuFilter(item.id)">
                                  取消筛选
                              </el-button>
                          </template>
                          <template slot-scope="scope">
                            <span v-if="(skuPropertyList.length === 1 && skuPropertyList[0].id === 0) || skuPropertyList.length > 1">{{scope.row.property_list[index].name}}</span>
                            <el-input v-else v-model="scope.row.property_list[index].name" size="mini"
                                      :class="['input-text-left']">
                              <span slot="append" class="hint">{{ scope.row.property_list[index].name.length }} / 18</span>
                            </el-input>
                          </template>
                      </el-table-column>
                      <el-table-column key="2" width="100">
                          <template slot="header" slot-scope="scope">
                              <span>库存</span>
                              <el-button type="text" class="table-header-btn" @click="dialogQuantityVisible=true"> <i class="el-icon-edit"></i> </el-button>
                          </template>
                          <template slot-scope="scope">
                              <el-input v-model.number="scope.row.quantity" size="mini" type="number"></el-input>
                          </template>
                      </el-table-column>
                      <el-table-column key="4" width="100">
                          <template slot="header" slot-scope="scope">
                              <span>价格</span>
                              <el-tooltip manua="true" class="item" effect="dark" placement="top" style="vertical-align: middle">
                                  <div slot="content">
                                    <ul style="padding: 0; margin: 0;">其他平台SKU价格，请在上传抖音时设置价格</ul>
                                  </div>
                                  <i class="el-icon-question"></i>
                              </el-tooltip>
                          </template>
                          <template slot-scope="scope">
                              <el-input v-if="scope.row.promo_price===0" v-model.number="scope.row.promo_price" size="mini" type="number"></el-input>
                              <span v-else>{{scope.row.promo_price}}</span>
                          </template>
                      </el-table-column>
                      <el-table-column key="5" label="预览图" width="100" align="center" class-name="cell-tight">
                          <template slot-scope="scope">
                              <img style="height:40px" :src="scope.row.img">
<!--                            <el-upload-->
<!--                                slot="footer"-->
<!--                                class="el-upload el-upload&#45;&#45;picture-card"-->
<!--                                :show-file-list="false"-->
<!--                                :on-success="(response, file, fileList) => handleUploadSuccess(response, file, fileList, scope.row)"-->
<!--                                :on-error="handleUploadError"-->
<!--                                :before-upload="handleBeforeUpload"-->
<!--                                action="/api/uploadProductImage"-->
<!--                                :headers="getTokenHeaders"-->
<!--                                :data="{'belong_type': belongType}"-->
<!--                                style="width:50px; height: 50px; line-height: 80px;"-->
<!--                            >-->
<!--                                <el-image :src="scope.row.img" style="width: 40px; height:40px; display: block;" fit="contain"></el-image>-->
<!--                            </el-upload>-->
                          </template>
                      </el-table-column>
                      <el-table-column key="6" v-if="skuPropertyList.length === 1 && skuRealShowList.length > 1" label="操作" width="80">
                        <template slot-scope="scope">
                            <el-button size="mini" @click="onDeleteSingleSku(scope.$index)" type="danger" plain>删除</el-button>
                        </template>
                      </el-table-column>
                  </el-table>
                  <div class="common-bottom">
                  </div>
              </el-tab-pane>

              <el-tab-pane label="轮播页" name="carousel">
                <div style="width: 100%; text-align: left;">
                  <el-button size="mini" sytle="" type="primary" @click="applyRemoveFirstBannerToSelection()">批量去除选中商品轮播图首图</el-button>
                  <el-button v-if="product.originModel.bannerPicUrlList && product.originModel.bannerPicUrlList.length > 1 && productRemoveFirstBannerDic[product.model.tp_product_id]" size="mini" sytle="" type="error" @click="cancelRemoveFirstBanner()">还原本商品轮播图</el-button>
                </div>
                 <span slot="label" v-if=" product.model.check_error_msg_static  && '2' in product.model.check_error_msg_static">轮播页
                     <el-tooltip effect="dark"  placement="top-start">
                      <div slot="content">
                           <ul style="padding: 0; margin: 0;" v-for="(v,i) in product.model.check_error_msg_static['2']['info']" :key="i">{{v}}</ul>
                      </div>
                      <el-badge :value="product.model.check_error_msg_static['2'].num" ></el-badge>
                  </el-tooltip>
                  </span>
                  <div style="overflow: auto;">
                      <div style="padding: 0 70px 5px; color: gray"> * 拖动可调整顺序 </div>
                      <pictures-upload-view @imageChanged="onBannerImageChanged" ref="bannerPicListView" :belongType="0" :containLimit="5" :pictureUrlList="bannerPicUrlList">
                      </pictures-upload-view>
                  </div>
                  <div class="common-bottom">
                  </div>
              </el-tab-pane>

              <el-tab-pane label="详情页" name="detail">
                <span slot="label" v-if=" product.model.check_error_msg_static  && '3' in product.model.check_error_msg_static">详情页
                     <el-tooltip effect="dark"  placement="top-start">
                      <div slot="content">
                           <ul style="padding: 0; margin: 0;" v-for="(v,i) in product.model.check_error_msg_static['3']['info']" :key="i">{{v}}</ul>
                      </div>
                      <el-badge :value="product.model.check_error_msg_static['3'].num" ></el-badge>
                  </el-tooltip>
                  </span>
                  <div style="overflow: auto;">
                      <div style="padding: 0 70px 5px; color: gray"> * 拖动可调整顺序 </div>
                      <pictures-upload-view @imageChanged="onDescImageChanged" ref="descPicListView" :belongType="1" :containLimit="-1" :pictureUrlList="descPicUrlList">
                      </pictures-upload-view>
                  </div>
                  <div class="common-bottom">
                  </div>
              </el-tab-pane>
              <el-tab-pane v-if="Object.keys(origionAttr).length > 0" label="来源数据">
                  <el-form class="setting-content" style="height: 460px">
                      <el-row>
                          <el-col :span="12">
                              <el-form-item v-for="(val, key, index) in origionAttr" :key="index" :label="key + ':'"
                                            v-if="index < Object.keys(origionAttr).length/2"
                              >
                                  <el-tooltip class="item" effect="light" placement="bottom">
                                      <div slot="content" style="max-width: 300px">{{ val }}</div>
                                      <span> {{ cutOrigionAttrStr(key, val) }} </span>
                                  </el-tooltip>
                              </el-form-item>
                          </el-col>
                          <el-col :span="12">
                              <el-form-item v-for="(val, key, index) in origionAttr" :key="index" :label="key + ':'"
                                            v-if="index >= Object.keys(origionAttr).length/2"
                              >
                                  <el-tooltip class="item" effect="light" placement="bottom">
                                      <div slot="content" style="max-width: 300px">{{ val }}</div>
                                      <span> {{ cutOrigionAttrStr(key, val) }} </span>
                                  </el-tooltip>
                              </el-form-item>
                          </el-col>
                      </el-row>
                  </el-form>
              </el-tab-pane>
          </el-tabs>

        <el-dialog class="dialog-tight" title="修改分类" width="800px" :visible.sync="dialogVisible" @opened="onOpenedCate" append-to-body center>
            <category-select-view ref="categorySelectView" @changeCate="onChangeCate">
            </category-select-view>
        </el-dialog>

        <el-dialog title="批量修改库存" width="400px" :visible.sync="dialogQuantityVisible" append-to-body center>
            <div>
                <el-radio v-model="stockHandler.radio" label="1">
                    <span style="display:inline-block; width:100px">统一库存为</span>
                    <el-input v-model="stockHandler.textStock" size="mini" style="width:100px"
                              @focus="stockHandler.radio='1'"
                    ></el-input>
                </el-radio><br>
                <el-radio v-model="stockHandler.radio" label="2">
                    <span style="display:inline-block; width:100px">每个SKU库存加</span>
                    <el-input v-model="stockHandler.textStockAdd" size="mini" style="width:100px"
                              @focus="stockHandler.radio='2'"
                    ></el-input>
                </el-radio><br>
                <el-radio v-model="stockHandler.radio" label="3">
                    <span style="display:inline-block; width:100px">每个SKU库存减</span>
                    <el-input v-model="stockHandler.textStockSub" size="mini" style="width:100px"
                              @focus="stockHandler.radio='3'"
                    ></el-input>
                    <span class="explain">&nbsp; 小于 0 设为 0</span>
                </el-radio>
                <div style="text-align: center; padding-top: 20px">
                    <el-button type="primary" @click="handleBatchQuantity">确定</el-button>
                    <el-button @click="dialogQuantityVisible = false">取消</el-button>
                </div>
            </div>
        </el-dialog>

      </el-col>
      <div style="display: flex; box-sizing: border-box; background-color: #EBEEF5; width: 100%; height: 80px; position: fixed; bottom: 0px; z-index: 999; margin-left: 10px;">
        <div style="width: 100%; height: 100%; padding-top: 20px; padding-left: 30px; text-align:right;">
            <el-button type="warning" style="display: block; " @click="onRevertSelection">全选/清空</el-button>
            <el-button type="warning" style="display: block; position: fixed; bottom: 20px; right: 140px; " @click="onRevertProduct">还原</el-button>
            <el-button type="primary" style="display: block; position: fixed; bottom: 20px; right: 20px; width: 100px;" @click="onSaveProduct">保存编辑</el-button>
        </div>
      </div>
    </el-row>
    <el-dialog
      title="保存中"
      :show-close="false"
      :visible.sync="isProductEditSaving"
      :closeOnClickModal="false"
      :append-to-body="true"
      width="30%">
       <el-progress :text-inside="true" :stroke-width="26" :percentage="productEditSavingPercent"></el-progress>
    </el-dialog>
    <el-dialog
      :visible.sync="applySelectCateToAllVisible"
      width="30%"
      :append-to-body="true">
      <span slot="title" style="font-size: large;"><i class="el-icon-warning" style="color: #fecf23"></i> 批量修改分类</span>
      <span>该操作会自动保存当前的所有编辑，改变本页被选中的商品的分类，并进行商品属性及sku的重新匹配（原先对属性及sku的编辑将被覆盖），是否继续？</span>
      <span slot="footer" class="dialog-footer">
        <el-button @click="applySelectCateToAllVisible = false">取 消</el-button>
        <el-button type="primary" @click="applySelectCateToAll">确 定</el-button>
      </span>
    </el-dialog>
    <el-dialog
      :visible.sync="batchEditTitleVisible"
      width="500px"
      :append-to-body="true">
      <span slot="title" style="font-size: large;"><i class="el-icon-warning" style="color: #fecf23"></i> 批量修改标题</span>
      <div>
        <div style="width: 440px;">
          <el-input v-model="textHandler.textPrefix" size="small" placeholder="前缀" style="width: 160px;"></el-input>
          <span>原标题</span>
          <el-input v-model="textHandler.textSuffix" size="small" placeholder="后缀" style="width: 160px;"></el-input>
          <el-button type="primary" size="small" @click="applyTitleChangeToSelection(0)" style="margin-left: 10px;">应用</el-button>
        </div>
      </div><br/>
      <div>
        <div style="width: 440px;">
          <el-input v-model="textHandler.textReplace1" size="small" style="width: 160px;"></el-input>
          <span>替换为</span>
          <el-input v-model="textHandler.textReplace2" size="small" style="width: 160px;"></el-input>
          <el-button type="primary" size="small" @click="applyTitleChangeToSelection(1)" style="margin-left: 10px;">应用</el-button>
        </div>
      </div><br/>
      <div>
        <div style="width: 440px;">
          <el-input v-model="textHandler.textDelete" size="small" style="width: 160px;" placeholder="输入删除关键字"></el-input>
          <el-button type="primary" size="small" @click="applyTitleChangeToSelection(2)" style="margin-left: 10px;">应用</el-button>
        </div>
      </div>
    </el-dialog>
  </div>
</template>
<script>
import picturesUploadView from '@/components/PicturesUploadView'
import categorySelectView from '@/components/CategorySelectView'
import attributeView from '@/components/AttributeView.vue'
import request from '@/mixins/request.js'
import skuHandler from '@/mixins/skuHandler.js'
import utils from '@/common/utils'
import FormModel from '@/common/formModel'
import { mapActions, mapGetters } from 'vuex'
import { TextHandler } from '@/common/batchEditHandler'

export default {
  inject: ['reload'],
  mixins: [request, skuHandler],
  components: {
    picturesUploadView,
    categorySelectView,
    attributeView
  },
  props: {
    belongType: {
      type: Number,
      default: 0
    }
  },
  data () {
    return {
      dialogVisible: false,
      dialogQuantityVisible: false,
      dialogPromoPriceVisible: false,
      dialogPriceVisible: false,
      product: new FormModel([
        'title', 'price', 'cat_id', 'outer_id', 'description', 'skuMap', 'bannerPicUrlList', 'descPicUrlList', 'attrs', 'brand_id'
      ]),
      template: new FormModel(),
      bannerPicUrlList: [],
      descPicUrlList: [],
      shopBrandList: [],
      origionAttr: {},
      isShowTemplateTab: false,
      saveBtnText: '保存',
      checkedRefundable: false,
      checkedFolt: false,
      haveAttr: false,
      isRequiredComplete: false,
      isShowShelvesCheck: false,
      checkedShelves: false,
      isShowPromoPriceEditBtn: false,
      msgSkuError: '',
      activityTab: 'info',
      products: {},
      // rawProducts: {},
      productList: [],
      productTitleDic: {},
      productRemoveFirstBannerDic: {},
      productBrandDic: {},
      productDic: {},
      attrApplyCatMap: {},
      saveAll: false,
      isProductEditSaving: false,
      productEditSavingPercent: 0,
      mouseOverIndex: -1,
      isLoading: false,
      applySelectCateToAllVisible: false,
      applySelectBrandToAllVisible: false,
      hasSelection: false,
      selectedProductIds: [],
      batchEditTitleVisible: false,
      textHandler: new TextHandler(),
      closeAfterSave: false
    }
  },
  watch: {
    product: {
      handler (val, oldVal) {
        if (oldVal.model.tp_product_id !== val.model.tp_product_id) {
          return
        }
        if (!this.productDic[val.model.tp_product_id]) {
          return
        }
        if (val.isDiff() || this.attrApplyCatMap[val.model.cat_id]) {
          this.productDic[val.model.tp_product_id].isEdit = true
        } else {
          this.productDic[val.model.tp_product_id].isEdit = false
        }
      },
      deep: true
    }
  },
  computed: {
    ...mapGetters({
      getTokenHeaders: 'getTokenHeaders'
    }),
    isTitleWarn () {
      if (utils.getStrRealLength(this.product.model.title) > 60) {
        return true
      }
      return false
    },
    showTooltip (idx) {
      return idx === this.mouseOverIndex
    }
  },
  mounted () {

  },
  updated () {
    if (this.activityTab === 'sku') {
      let self = this
      if (this.skuPropertyList.length === 1) {
        return
      }
      this.skuPropertyList.forEach(item => {
        if (self.skuPropertyValueMap[item.id]) {
          for (let vid in self.skuPropertyValueMap[item.id]) {
            let ele = self.skuPropertyValueMap[item.id][vid]
            if (self.isSkuNameWarn(ele.value, item.id)) {
              if (self.$refs['sku-property-' + item.id]) {
                self.$refs['sku-property-' + item.id][0].show()
              }
            }
          }
        }
      })
      if ('1' in this.product.model.check_error_msg_static) {
        if ('1017' in this.product.model.check_error_msg_static['1']['code']) {
          let maxNum = 0
          let maxNumProperty = 0
          this.skuPropertyList.forEach(item => {
            if (self.skuPropertyValueMap[item.id]) {
              let len = Object.keys(self.skuPropertyValueMap[item.id]).length
              if (len > maxNum) {
                maxNumProperty = item.id
                maxNum = len
              }
            }
          })
          if (this.$refs['sku-property-' + maxNumProperty]) {
            this.$refs['sku-property-' + maxNumProperty][0].show()
          }
        }
      }
    }
  },
  methods: {
    ...mapActions([
      // 'setIsShowFloatView'
    ]),
    ...mapGetters({
      subsc: 'getCurrentSubsc'
    }),
    initList (tpProduct, tpProductList = []) {
      // this.setIsShowFloatView(false)
      this.productList = tpProductList
      for (let i in this.productList) {
        this.productDic[this.productList[i].tp_product_id] = this.productList[i]
        this.productTitleDic[this.productList[i].tp_product_id] = this.productList[i].title
        this.productRemoveFirstBannerDic[this.productList[i].tp_product_id] = false
      }
      this.$refs.productList.setCurrentRow(tpProduct)
      let self = this
      setTimeout(function () {
        self.$refs.productList.$el.scrollTop = 85 * tpProduct.index
      }, 100)
      this.$refs.productList.toggleAllSelection()
      this.hasSelection = true
    },
    setProduct (tpProduct) {
      if (!(tpProduct.tp_product_id in this.products)) {
        this.product = new FormModel([
          'title', 'price', 'cat_id', 'outer_id', 'description',
          'skuMap', 'skuShowList', 'bannerPicUrlList', 'descPicUrlList', 'attrs', 'attrDic', 'attrList', 'brand_id'
        ])
        this.product.assign({
          tp_product_id: tpProduct.tp_product_id,
          title: tpProduct.title,
          price: utils.fenToYuan(tpProduct.max_price),
          cat_id: tpProduct.category_id,
          category_show: tpProduct.category_show,
          outer_id: tpProduct.tp_outer_iid,
          description: '',
          check_error_msg_static: tpProduct.check_error_msg_static
        })
        this.products[tpProduct.tp_product_id] = this.product
        this.updateProperty(tpProduct.tp_product_id)
      } else {
        this.product = this.products[tpProduct.tp_product_id]
        this.$refs.attributeView.setAttrRawDic(this.product.model.attrDic)
        this.$refs.attributeView.setAttrShowList(this.product.model.attrList)
        this.$refs.attributeView.setAttrApplyCatMap(this.attrApplyCatMap)
        this.$refs.attributeView.reloadAttrShowList()
        this.skuPropertyList = this.product.model.skuPropertyList
        this.skuPropertyValueMap = this.product.model.skuPropertyValueMap
        this.skuShowList = this.product.model.skuShowList
        this.bannerPicUrlList = [...this.product.model.bannerPicUrlList]
        // this.$refs['bannerPicListView'].curPictureList = this.product.model.bannerPicUrlList
        this.descPicUrlList = [...this.product.model.descPicUrlList]
        // this.$refs['descPicListView'].curPictureList = this.product.model.descPicUrlList
        this.origionAttr = this.product.model.originAttr
        this.updateTitleChange()
        this.updateRemoveFirstBanner()
      }
    },
    handleProductSelect (val, old) {
      if (this.isLoading) {
        return false
      }
      if (old) {
        this.updateProductEditStatus()
      }
      this.setProduct(val)
    },
    setActiveTab () {
      if (this.product.model.check_error_msg_static) {
        if ('0' in this.product.model.check_error_msg_static) {
          return 'info'
        }
        if ('1' in this.product.model.check_error_msg_static) {
          return 'sku'
        }
        if ('2' in this.product.model.check_error_msg_static) {
          return 'carousel'
        }
        if ('3' in this.product.model.check_error_msg_static) {
          return 'detail'
        }
      }
      return 'info'
    },
    updateProperty (tpProductId, catId = -1) {
      this.isLoading = true
      let params = { tp_product_id: tpProductId, cat_id: catId }
      this.request('getTPProductProperty', params, data => {
        this.origionAttr = data.raw_attribute_json ? data.raw_attribute_json : {}
        this.$refs.attributeView.setAttrApplyCatMap({})
        data.attribute_json = {}
        this.haveAttr = this.$refs.attributeView.initAttribute(data.attribute_json, this.product.model.cat_id)

        this.bannerPicUrlList = data.banner_json
        this.descPicUrlList = data.desc_json
        this.shopBrandList = data.shop_brand_list
        this.product.assign({description: data.desc_text})
        this.initSku(data.sku_json, data.tp_id)
        this.updateIsSingleSku()

        this.product.assign({skuMap: this.getSkuUploadObj().sku_map})
        this.product.assign({bannerPicUrlList: data.banner_json})
        this.product.assign({descPicUrlList: data.desc_json})
        this.product.assign({attrs: JSON.parse(JSON.stringify(this.$refs.attributeView.getAttrUploadList()))})
        this.product.assign({attrDic: {...this.$refs.attributeView.attrRawDic}})
        this.product.assign({attrList: [...this.$refs.attributeView.attrShowList]})
        this.product.assign({skuPropertyList: [...this.skuPropertyList]})
        this.product.assign({skuPropertyValueMap: {...this.skuPropertyValueMap}})
        this.product.assign({skuShowList: [...this.skuShowList]})
        this.product.assign({originAttr: {...this.origionAttr}})
        if (data.brand_id) {
          this.product.assign({brand_id: data.brand_id})
        }
        this.skuPropertyList = this.product.model.skuPropertyList
        this.skuPropertyValueMap = this.product.model.skuPropertyValueMap
        this.skuShowList = this.product.model.skuShowList

        this.$refs.attributeView.setAttrApplyCatMap(this.attrApplyCatMap)
        this.$refs.attributeView.reloadAttrShowList()

        this.updateTitleChange()
        this.updateRemoveFirstBanner()

        if (this.productBrandDic.hasOwnProperty(this.product.model.tp_product_id)) {
          this.product.model.brand_id = this.productBrandDic[this.product.model.tp_product_id]
        }

        this.isLoading = false
      }, data => {
        if (tpProductId in this.products) {
          delete this.products[tpProductId]
        }
        this.isLoading = false
      })
    },
    isTitleInfoWarn () {
      if (this.product.model.check_error_msg_static) {
        if ('0' in this.product.model.check_error_msg_static) {
          if ('1005' in this.product.model.check_error_msg_static['0']['code']) {
            return true
          }
        }
      }
      return false
    },
    getStrRealLength (str) {
      return utils.getStrRealLength(str)
    },
    showSelectCateView () {
      this.dialogVisible = true
    },
    onOpenedCate () {
      if (this.product.model.cat_id !== 0) {
        this.$refs.categorySelectView.initCate(this.product.model.cat_id, this.product.model.category_show)
      } else {
        this.$refs.categorySelectView.initCate()
      }
    },
    onChangeCate (data) {
      this.dialogVisible = false
      Object.assign(this.product.model, {cat_id: data.id})
      this.product.model.category_show = data.name
      this.updateProperty(this.product.model.tp_product_id, this.product.model.cat_id)
    },
    onBannerImageChanged (bannerPicUrlList) {
      Object.assign(this.product.model, {bannerPicUrlList: [...bannerPicUrlList]})
    },
    onDescImageChanged (descPicUrlList) {
      Object.assign(this.product.model, {descPicUrlList: [...descPicUrlList]})
    },
    onAttrChanged (isRequiredComplete) {
      Object.assign(this.product.model, {attrDic: {...this.$refs.attributeView.attrRawDic}})
      Object.assign(this.product.model, {attrList: [...this.$refs.attributeView.attrShowList]})
      this.isRequiredComplete = isRequiredComplete
    },
    selectFilter (templatePid, key, callback) {
      let params = {
        cat_id: this.product.model.cat_id,
        template_pid: templatePid,
        key: key
      }
      this.request('selectFilter', params, data => {
        callback(data)
      }, undefined, true)
    },
    updateAttrApplyCat (attrApplyCat) {
      this.attrApplyCatMap = Object.assign({}, attrApplyCat)
      this.updateProductEditStatus()
    },
    handleBatchQuantity () {
      this.batchEditQuantity()
      this.dialogQuantityVisible = false
    },
    handlePropertyNameChange (pid, vid, ele) {
      this.updateNameOfSkuPropertyValueMap(pid, vid, ele['value'])
    },
    isSkuNameWarn (skuName, idx) {
      let cnt = 0
      for (let key in this.skuPropertyValueMap[idx]) {
        if (this.skuPropertyValueMap[idx][key]['value'].trim() === skuName.trim()) {
          cnt += 1
        }
      }
      if (cnt > 1) {
        return true
      }
      return skuName.length > 18
    },
    reloadBrandList () {
      this.request('getShopBrandList', {}, data => {
        this.shopBrandList = data
      })
    },
    onDeleteSku (pId, pVid) {
      this.deleteSkus(pId, pVid)
    },
    onDeleteSingleSku (idx) {
      this.deleteSingleSku(idx)
    },
    cutOrigionAttrStr (key, val) {
      let len = 50 - utils.getStrRealLength(key)
      let retStr = utils.getStrRealPrefix(val, len)
      if (val.length !== retStr.length) {
        retStr += '...'
      }
      return retStr
    },
    productListCellStyle ({row, column, rowIndex, columnIndex}) {
      if (
        this.productList.length > 0 &&
        this.productList[rowIndex].tp_product_id !== this.product.model.tp_product_id &&
        this.productList[rowIndex].category_id === this.product.model.cat_id) {
        return 'background-color:rgb(236, 245, 255);'
      }
      if (
        this.productList.length > 0 &&
        this.productList[rowIndex].tp_product_id === this.product.model.tp_product_id) {
        return 'background-color:rgb(179, 216, 255);'
      }
    },
    onSaveProduct () {
      this.productEditSavingPercent = 0
      this.isProductEditSaving = true
      if (window._hmt) {
        window._hmt.push(['_trackEvent', '复制商品', '点击', '完成批量修改商品'])
      }
      this.saveProducts()
    },
    saveProducts (cid = -1, updateCategoryTPProductIds = []) {
      let tpProductList = []
      let tpProductIdList = []
      for (let i in this.productList) {
        let tpProductId = this.productList[i].tp_product_id
        // 处理单个修改的商品
        if (this.products[tpProductId] && this.products[tpProductId].isDiff()) {
          if (tpProductId in this.products) {
            let product = this.products[tpProductId]
            let productParams = {
              tp_product_id: product.model.tp_product_id,
              category_id: product.model.cat_id,
              title: product.model.title,
              price: utils.yuanToFen(product.model.price),
              tp_outer_iid: product.model.outer_id,
              tp_property_json: {
                attribute_json: this.$refs.attributeView.getAttrUploadListByShowList(product.model.attrList),
                desc_text: product.model.description,
                sku_json: this.getSkuUploadObjByShowList(product.model.skuShowList),
                banner_json: product.model.bannerPicUrlList.map(val => val['url']),
                desc_json: product.model.descPicUrlList.map(val => val['url']),
                brand_id: product.model.brand_id || 0
              }
            }
            tpProductList.push(productParams)
          }
        } else {
          let productParams = {
            tp_product_id: this.productList[i].tp_product_id,
            category_id: this.productList[i].category_id,
            title: this.productList[i].title,
            price: utils.yuanToFen(this.productList[i].price),
            tp_outer_iid: this.productList[i].tp_outer_iid
          }
          let isChange = false
          if (this.productList[i].title !== this.productTitleDic[tpProductId]) {
            productParams['title'] = this.productTitleDic[this.productList[i].tp_product_id]
            isChange = true
          }
          if (this.productRemoveFirstBannerDic[tpProductId] && !this.products[tpProductId]) {
            productParams['tp_property_json'] = {
              remove_first_banner: true
            }
            isChange = true
          }
          if (this.productBrandDic.hasOwnProperty(tpProductId) && !this.products[tpProductId]) {
            productParams['tp_property_json'] = {
              brand_id: this.productBrandDic[tpProductId] || 0
            }
            isChange = true
          }
          if (isChange) {
            tpProductList.push(productParams)
          }
        }
        // 处理批量修改属性的商品
        if (this.attrApplyCatMap[this.productList[i].category_id]) {
          tpProductIdList.push(tpProductId)
        }
      }
      this.requestBatchUpdateTPProduct(tpProductList, tpProductIdList, this.attrApplyCatMap, 0, 0, cid, updateCategoryTPProductIds)
    },
    requestBatchUpdateTPProduct (tpProductList, tpProductIdList, attrApplyCatMap, tpProductListIdx, tpProductIdListIdx, cid, updateCategoryTPProductIds) {
      let tpProductListSlice = []
      let tpProductIdListSlice = []
      let attrApplyCatMapTemp = {}

      if (tpProductListIdx < tpProductList.length) {
        tpProductListSlice = tpProductList.slice(tpProductListIdx, tpProductListIdx + 5)
      } else if (tpProductIdListIdx < tpProductIdList.length) {
        tpProductIdListSlice = tpProductIdList.slice(tpProductIdListIdx, tpProductIdListIdx + 5)
        attrApplyCatMapTemp = attrApplyCatMap
      }
      let self = this
      this.request('batchUpdateTPProduct', {
        tp_product_list: JSON.stringify(tpProductListSlice),
        tp_product_id_list: tpProductIdListSlice,
        attr_apply_map: JSON.stringify(attrApplyCatMapTemp)
      }, data => {
        // 更新商品列表信息
        self.changeProducts(data)

        // 更新已经保存的商品信息
        for (let i in tpProductListSlice) {
          let tpProductId = tpProductListSlice[i].tp_product_id
          if (self.products && tpProductId in self.products) {
            self.products[tpProductId].saveNow()
          }
        }

        if (tpProductListIdx >= tpProductList.length && tpProductIdListIdx >= tpProductIdList.length) {
          if (cid !== -1) {
            this.requestApplySelectCateToAll(this.product.model.cat_id, updateCategoryTPProductIds, 0, 50)
            return
          }
          // 批量保存完成
          self.productEditSavingPercent = 100
          self.products = {}
          self.productBrandDic = {}
          self.updateAttrApplyCat({})
          for (let i in this.productList) {
            this.productTitleDic[this.productList[i].tp_product_id] = this.productList[i].title
            this.productRemoveFirstBannerDic[this.productList[i].tp_product_id] = false
          }
          self.setProduct(self.productDic[self.product.model.tp_product_id])
          this.updateProductEditStatus()
          this.isProductEditSaving = false
          if (self.closeAfterSave) {
            this.$emit('triggerDialogClose')
            self.closeAfterSave = false
          }
          this.$message({
            message: '保存成功',
            type: 'success'
          })
        } else {
          // 批量保存没完成继续处理
          let cnt = Math.min(tpProductListIdx + 5, tpProductList.length) + Math.min(tpProductIdListIdx + 5, tpProductIdList.length)
          if (cid !== -1) {
            self.productEditSavingPercent = parseInt(50 * cnt / (tpProductList.length + tpProductIdList.length))
          } else {
            self.productEditSavingPercent = parseInt(100 * cnt / (tpProductList.length + tpProductIdList.length))
          }
          if (tpProductListIdx < tpProductList.length) {
            self.requestBatchUpdateTPProduct(tpProductList, tpProductIdList, attrApplyCatMap, tpProductListIdx + 5, tpProductIdListIdx, cid, updateCategoryTPProductIds)
          } else {
            self.requestBatchUpdateTPProduct(tpProductList, tpProductIdList, attrApplyCatMap, tpProductListIdx, tpProductIdListIdx + 5, cid, updateCategoryTPProductIds)
          }
        }
      }, data => {
        this.isProductEditSaving = false
        if (data.message.includes('无法获取锁')) {
          this.$message({
            message: '已有任务在运行',
            type: 'warning'
          })
        } else {
          this.$message({
            message: '保存失败',
            type: 'error'
          })
        }
      }, true)
    },
    changeProducts (data, changeCid = false) {
      let arrTPProduct = []
      for (let i in data) {
        let tpProductId = data[i].tp_product_id
        if (tpProductId in this.products) {
          let tpProduct = {
            status: data[i].status,
            migration_msg: data[i].migration_msg,
            check_error_msg_static: data[i].check_error_msg_static,
            price: utils.yuanToFen(this.products[tpProductId].model.price),
            title: this.products[tpProductId].model.title,
            category_id: this.products[tpProductId].model.cat_id,
            category_show: this.products[tpProductId].model.category_show,
            tp_product_id: tpProductId
          }
          if (changeCid) {
            tpProduct['price'] = data[i].price
            tpProduct['title'] = data[i].title
            tpProduct['category_id'] = data[i].category_id
            tpProduct['category_show'] = data[i].category_show
          }
          this.products[tpProductId].model.check_error_msg_static = data[i].check_error_msg_static
          this.products[tpProductId].model.migration_msg = data[i].migration_msg
          arrTPProduct.push(tpProduct)
        } else if (tpProductId in this.productDic) {
          let tpProduct = {
            status: data[i].status,
            migration_msg: data[i].migration_msg,
            check_error_msg_static: data[i].check_error_msg_static,
            price: this.productDic[tpProductId].max_price,
            title: this.productTitleDic[tpProductId],
            category_id: this.productDic[tpProductId].category_id,
            category_show: this.productDic[tpProductId].category_show,
            tp_product_id: tpProductId
          }
          if (changeCid) {
            tpProduct['price'] = data[i].price
            tpProduct['title'] = data[i].title
            tpProduct['category_id'] = data[i].category_id
            tpProduct['category_show'] = data[i].category_show
          }
          arrTPProduct.push(tpProduct)
        }
      }
      this.$emit('changeProducts', arrTPProduct)
    },
    isProductChange () {
      return this.updateProductEditStatus()
    },
    onRevertProduct () {
      for (let i in this.products) {
        this.products[i].rollback()
      }
      for (let i in this.productList) {
        this.productTitleDic[this.productList[i].tp_product_id] = this.productList[i].title
        this.productRemoveFirstBannerDic[this.productList[i].tp_product_id] = false
      }
      this.productBrandDic = {}
      this.updateAttrApplyCat({})
      this.$refs.attributeView.setAttrRawDic(this.product.model.attrDic)
      this.$refs.attributeView.setAttrShowList(this.product.model.attrList)
      this.$refs.attributeView.setAttrApplyCatMap(this.attrApplyCatMap)
      this.$refs.attributeView.reloadAttrShowList()
      this.skuPropertyList = this.product.model.skuPropertyList
      this.skuPropertyValueMap = this.product.model.skuPropertyValueMap
      this.skuShowList = this.product.model.skuShowList
      this.$refs['bannerPicListView'].setCurPictureList(this.product.model.bannerPicUrlList)
      this.$refs['descPicListView'].setCurPictureList(this.product.model.descPicUrlList)
    },
    onClose () {
      // this.setIsShowFloatView(true)
      for (let i in this.productList) {
        this.productList[i].isEdit = false
      }
      this.productDic = {}
      this.productList = []
      this.products = {}
      this.skuPropertyList = []
      this.skuShowList = []
      this.productTitleDic = {}
      this.productRemoveFirstBannerDic = {}
      this.productBrandDic = {}
      this.updateAttrApplyCat({})
      this.$refs['bannerPicListView'].clear()
      this.$refs['descPicListView'].clear()
      this.$refs['attributeView'].clear()
    },
    handleMouseEnter (row, column, cell, event) {
      if (this.mouseOverIndex === row.index) {
        return
      }
      this.mouseOverIndex = row.index
    },
    handleMouseOut (row, column, cell, event) {
      // this.mouseOverIndex = -1
    },
    onApplySelectCateToSelection () {
      if (window._hmt) {
        window._hmt.push(['_trackEvent', '复制商品', '点击', '点击批量修改类别'])
      }
      this.applySelectCateToAllVisible = true
    },
    updateProductEditStatus () {
      let isChanged = false
      for (let i in this.productList) {
        let tpProductId = this.productList[i].tp_product_id
        if (
          this.productDic[tpProductId].title !== this.productTitleDic[tpProductId] ||
          (this.products[tpProductId] && this.products[tpProductId].isDiff()) ||
          this.attrApplyCatMap[this.productList[i].category_id] ||
          (this.productRemoveFirstBannerDic[tpProductId] && (!this.products[tpProductId] || (this.products[tpProductId] && this.products[tpProductId].model.bannerPicUrlList.length > 1))) ||
          (this.productBrandDic.hasOwnProperty(tpProductId) && !this.products[tpProductId])
        ) {
          this.productDic[tpProductId].isEdit = true
          isChanged = true
        } else {
          this.productDic[tpProductId].isEdit = false
        }
      }
      return isChanged
    },
    cancelRemoveFirstBanner () {
      this.product.rollbackPart('bannerPicUrlList')
      this.bannerPicUrlList = [...this.product.model.bannerPicUrlList]
      this.productRemoveFirstBannerDic[this.product.model.tp_product_id] = false
    },
    applyRemoveFirstBannerToSelection () {
      if (window._hmt) {
        window._hmt.push(['_trackEvent', '复制商品', '点击', '点击批量去除轮播图首图'])
      }
      for (let i in this.selectedProductIds) {
        let tpProductId = this.selectedProductIds[i]
        this.productRemoveFirstBannerDic[tpProductId] = true
      }
      this.updateProductEditStatus()
      this.updateRemoveFirstBanner()
    },
    applySelectBrandToSelection () {
      for (let i in this.selectedProductIds) {
        let tpProductId = this.selectedProductIds[i]
        this.productBrandDic[tpProductId] = this.product.model.brand_id
      }
      for (let i in this.productList) {
        let tpProductId = this.productList[i].tp_product_id
        if (tpProductId in this.products) {
          let product = this.products[tpProductId]
          if (this.productBrandDic.hasOwnProperty(tpProductId)) {
            Object.assign(product.model, {brand_id: this.productBrandDic[tpProductId]})
          }
        }
      }
      this.updateProductEditStatus()
      this.$message({
        message: '应用成功',
        type: 'success'
      })
    },
    updateRemoveFirstBanner () {
      for (let i in this.productList) {
        let tpProductId = this.productList[i].tp_product_id
        if (tpProductId in this.products) {
          let product = this.products[tpProductId]
          if (this.productRemoveFirstBannerDic[tpProductId] && product.originModel.bannerPicUrlList.length > 0) {
            let firstImg = product.originModel.bannerPicUrlList[0]
            let delIdx = -1
            for (let i in product.model.bannerPicUrlList) {
              if (product.model.bannerPicUrlList[i].url === firstImg.url) {
                delIdx = i
                break // 可能会有相同 URL 图片
              }
            }
            if (delIdx !== -1 && product.model.bannerPicUrlList.length > 1) {
              product.model.bannerPicUrlList.splice(delIdx, 1)
              if (this.product.model.tp_product_id === tpProductId) {
                this.bannerPicUrlList = [...product.model.bannerPicUrlList]
              }
            }
          }
        }
      }
    },
    onApplyTitleEditToSelection () {
      if (window._hmt) {
        window._hmt.push(['_trackEvent', '复制商品', '点击', '点击批量修改标题'])
      }
      this.batchEditTitleVisible = true
    },
    updateTitleChange () {
      if (this.product.model.title !== this.productTitleDic[this.product.model.tp_product_id]) {
        Object.assign(this.product.model, {title: this.productTitleDic[this.product.model.tp_product_id]})
      }
    },
    applyTitleChangeToSelection (type) {
      for (let i in this.selectedProductIds) {
        let tpProductId = this.selectedProductIds[i]
        this.productTitleDic[tpProductId] = this.textHandler.handle(this.productTitleDic[tpProductId], type)
      }
      this.updateProductEditStatus()
      this.updateTitleChange()
      this.textHandler.reset()
      this.batchEditTitleVisible = false
      this.$message({
        message: '应用成功',
        type: 'success'
      })
    },
    onProductTitleChange (val) {
      if (this.product) {
        this.productTitleDic[this.product.model.tp_product_id] = val
      }
    },
    applySelectCateToAll () {
      if (window._hmt) {
        window._hmt.push(['_trackEvent', '复制商品', '点击', '完成批量修改类别'])
      }
      this.productEditSavingPercent = 0
      this.isProductEditSaving = true
      this.applySelectCateToAllVisible = false
      let tpProductIdList = []
      for (let i in this.selectedProductIds) {
        if (this.selectedProductIds[i] !== this.product.model.tp_product_id) {
          tpProductIdList.push(this.selectedProductIds[i])
        }
      }
      this.saveProducts(this.product.model.cat_id, tpProductIdList)
    },
    requestApplySelectCateToAll (cid, tpProductIdList, tpProductIdListIdx, minPercent) {
      let tpProductIdListSlice = []

      if (tpProductIdListIdx < tpProductIdList.length) {
        tpProductIdListSlice = tpProductIdList.slice(tpProductIdListIdx, tpProductIdListIdx + 5)
      }
      let self = this
      this.request('batchUpdateCategory', {
        cid: cid,
        tp_product_ids: tpProductIdListSlice
      }, data => {
        // 更新商品列表信息
        self.changeProducts(data, true)

        // 更新已经保存的商品信息
        for (let i in tpProductIdListSlice) {
          let tpProductId = tpProductIdListSlice[i].tp_product_id
          if (tpProductId !== self.product.model.tp_product_id && self.products && tpProductId in self.products) {
            delete self.products[tpProductId]
          }
        }

        if (tpProductIdListIdx >= tpProductIdList.length) {
          // 批量保存完成
          self.productEditSavingPercent = 100
          self.products = {}
          self.updateAttrApplyCat({})
          self.setProduct(self.productDic[self.product.model.tp_product_id])
          this.isProductEditSaving = false
          this.$message({
            message: '保存成功',
            type: 'success'
          })
        } else {
          // 批量保存没完成继续处理
          let cnt = Math.min(tpProductIdListIdx + 5, tpProductIdList.length)
          self.productEditSavingPercent = parseInt(minPercent + (100 - minPercent) * cnt / tpProductIdList.length)
          if (tpProductIdListIdx < tpProductIdList.length) {
            self.requestApplySelectCateToAll(cid, tpProductIdList, tpProductIdListIdx + 5, minPercent)
          }
        }
      }, data => {
        this.isProductEditSaving = false
        if (data.message.includes('无法获取锁')) {
          this.$message({
            message: '已有任务在运行',
            type: 'warning'
          })
        } else {
          this.$message({
            message: '保存失败',
            type: 'error'
          })
        }
      }, true)
    },
    onRevertSelection () {
      if (this.hasSelection) {
        this.$refs.productList.clearSelection()
        this.hasSelection = false
      } else {
        this.$refs.productList.toggleAllSelection()
        this.hasSelection = true
      }
    },
    handleSelectionChange (selection) {
      this.selectedProductIds = []
      for (let i in selection) {
        this.selectedProductIds.push(selection[i].tp_product_id)
      }
      if (this.selectedProductIds.length === 0) {
        this.hasSelection = false
      } else {
        this.hasSelection = true
      }
    },
    handleBeforeUpload (file) {
      let type = file.type
      let size = file.size / 1024 / 1024
      if (type !== 'image/jpeg' && type !== 'image/png') {
        this.$message.error('只能上传jpg/jpeg/png文件')
        return false
      }
      if (size > 8) {
        this.$message.error('上传文件超过8M')
        return false
      }
    },
    handleUploadSuccess (response, file, fileList, row) {
      if (parseInt(response.code) !== 0) {
        if (response.msg) {
          this.$message.error(response.msg)
        }
        return
      }
      row.img = response.data.image_url
    },
    handleUploadError (err, file, fileList) {
      this.$message.error(err.message)
    }
  }
}
</script>
<style lang="less" scoped>
  @import '~@/assets/css/base.less';
  /deep/ .el-tabs__content {
    height: 100%;
    overflow-y: auto;
  }
  /deep/ .el-table__body tr.current-row>td {
    background-color: rgb(179, 216, 255);
  }
  /deep/ .cell {
    overflow: unset;
  }
</style>
