<!-- 组合商品 -->
<template>
  <div class='combination left relative'>
    <el-tabs v-model="activeTab" @tab-click="handleClick" class="tabs">
      <el-tab-pane :label="tab.label" v-for="(tab) in tabs" :key="tab.label"></el-tab-pane>
    </el-tabs>

    <div  class="form" :style="{'padding-bottom': mBottom}">
      <!-- 基础信息 -->
      <BasicInfo class="content combination-basicInfo" ref="BasicInfo"/>

      <!-- 规格 -->
      <TableSepcify class="content combination-specify " @refresh="refresh" ref="TableSepcify"/>

      <!-- 类目价格 -->
      <Price class="content combination-price " ref="Price"/>

      <!-- 支付设置 -->
      <PaySet class="content combination-paySet" ref="PaySet"/>

      <!-- 服务与资质 -->
      <ServiceComponent class="content combination-service" ref="Service"/>

      <div class="flex justify-c align-c btn" ref="btn">
        <el-button type="primary" plain style="width:120px"  @click="handleCancle">保存草稿箱</el-button>
        <el-button type="primary" style="width:120px"  @click="handleClose">发布商品</el-button>
      </div>
    </div>
  </div>
</template>

<script>
import debounce from 'lodash/debounce'
import TableSepcify from './components/TableSepcify'
import Price from './components/Price'
import PaySet from './components/PaySet'
import ServiceComponent from './components/Service'
import BasicInfo from './components/BasicInfo'
import servises from '@servises'

export default {
  data () {
    return {
      activeTab: '',
      tabs: [
        { label: '基础信息', className: '.combination-basicInfo' },
        { label: '规格', className: '.combination-specify' },
        { label: '类目价格', className: '.combination-price' },
        { label: '支付设置', className: '.combination-paySet' },
        { label: '服务与资质', className: '.combination-service' }
      ]

    }
  },
  computed: {},
  watch: {},
  created () {

  },
  mounted () {
    this.setScrollTop()
    this.bindScroll()
  },
  beforeMount () {
    this.unBindScroll()
  },
  activated () {
    this.bindScroll()
    this.activeTab = '0'
  },
  deactivated () {
    this.unBindScroll()
  },
  components: {
    TableSepcify,
    Price,
    PaySet,
    ServiceComponent,
    BasicInfo
  },
  methods: {
    refresh () {
      this.setScrollTop()
    },
    setScrollTop: debounce(function () {
      this.$nextTick(() => {
        const tab = this.tabs
        let maxPaddingBottom = 0
        const height =
      document.documentElement.offsetHeight || document.body.offSetHeight
        let previous = 0
        let current = previous
        const nextTab = tab.map((item, index) => {
          const className = item.className
          const el = document.querySelector(className)
          const rect = el.getBoundingClientRect()
          const top = rect.top
          const elHeight = rect.height
          const marginBottom = index ? 16 : 0
          const dist = 120
          if (tab.length - 1 === index) {
            maxPaddingBottom = height - elHeight - dist
          }
          const result = {
            ...item,
            scrollTop: previous + current + marginBottom,
            top
          }
          previous = previous + current + marginBottom
          current = elHeight
          return result
        })
        this.tabs = nextTab

        this.mBottom = `${maxPaddingBottom}px`
      })
    }, 300),
    bindScroll () {
      const scrollEl = document.querySelector('.page-component__scroll')
      scrollEl.addEventListener('scroll', this.scroll)
    },
    unBindScroll () {
      const scrollEl = document.querySelector('.page-component__scroll')
      scrollEl && scrollEl.removeEventListener('scroll', this.scroll)
    },
    scroll: debounce(function (e) {
      const scrollTop = e.target.scrollTop
      let active = 0
      const dist = 10
      this.tabs.forEach((item, index) => {
        if ((scrollTop + dist) >= item.scrollTop) {
          active = index
        }
      })
      this.changeActive(active)
    }, 300),
    changeActive: function (active) {
      this.activeTab = active.toString()
    },
    handleClick (index) {
      this.unBindScroll()
      const n = this.activeTab
      const tabsHeight = 0
      const marginBottom = 0
      const scrollTop = this.tabs[n].scrollTop + tabsHeight + marginBottom * n
      this.$nextTick(() => {
        const elScroll = document.querySelector('.page-component__scroll')
        elScroll.scrollTo({
          top: scrollTop,
          left: 0,
          behavior: 'smooth'
        })
      })
    },
    async handleClose () {
      const basicInfoPromise = this.$refs.BasicInfo.getForm()
      const pricePromise = this.$refs.Price.getForm()
      const paySetPromise = this.$refs.PaySet.getForm()
      const servicePromise = this.$refs.Service.getForm()
      const TableSepcifyPromise = this.$refs.TableSepcify.getForm()
      // todo 修改规格数量和价格时候 组合价格库存变动的逻辑
      Promise.all([ basicInfoPromise, pricePromise, paySetPromise, servicePromise, TableSepcifyPromise ])
        .then(([basicInfoData, priceData, paySetData, serviceData, TableSepcifyData]) => {
          const parmas = {
            ...basicInfoData,
            ...priceData,
            ...paySetData,
            ...serviceData,
            ...TableSepcifyData
          }
          console.log(parmas, 'parmas')
          servises.thirdpartDyGoodsBundleCreate({parmas}).then(data => {

          })
        // const
        }).catch((err) => {
          console.log(err)
          let isError = document.getElementsByClassName('is-error')
          this.$message.error('请按提示修改错误')
          if (isError && isError[0]) {
            this.$nextTick(() => {
              isError[0].scrollIntoView({
                // 滚动到指定节点
                // 值有start,center,end，nearest，当前显示在视图区域中间
                block: 'center',
                // 值有auto、instant,smooth，缓动动画（当前是慢速的）
                behavior: 'smooth'
              })
            })
          }
        }).finally(() => {

        })
    }
  }
}
</script>

<style lang='less' scoped>
    @import '~./index.less';
</style>
